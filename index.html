<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TG GROUP - Exchange (Final)</title>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
<!-- Changed Inter to Poppins as primary font for professional look -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>

<!-- üî• 1. FIREBASE SDKs üî• -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        primary: "#007BFF",
        success: "#28a745",
        danger: "#dc3545",
        'background-light': "#F7F9FC",
        'tg-green': "#34a853", 
      },
      fontFamily: { display: ["Poppins","sans-serif"] }, /* Changed font family */
      borderRadius: { DEFAULT: "0.5rem" }
    }
  }
}
</script>
<style>
/* Base Styles */
:root{
    --sidebar-w:280px;
    --sidebar-collapsed-w:64px;
    
    /* NEW AUTH STYLES VARS */
    --main-color: #007BFF; /* Primary color used for professional look */
    --main-green: #38c172; /* Gradient green-ish start */
    --light-green-end: #00f2fe; /* Gradient light blue/cyan end */
    --light-bg: #f0f2f5;
    --card-bg-opacity: 0.95;
    --white: #ffffff;
    --shadow-light: rgba(255, 255, 255, 0.4);
    --shadow-dark: rgba(0, 0, 0, 0.15);
}
.material-symbols-outlined{font-variation-settings:'FILL' 0,'wght' 400,'GRAD' 0,'opsz'24;}
body{font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial; margin:0; background:var(--background-light); color:#0f172a;}
.app { display:flex; min-height:100vh; }
aside{ width:var(--sidebar-w); min-width:var(--sidebar-w); background:white; border-right:1px solid #e6eef8; display:flex; flex-direction:column; transition: all .22s ease; z-index:1000; }
aside.collapsed{ width:var(--sidebar-collapsed-w); min-width:var(--sidebar-collapsed-w); }
.brand{ display:flex; align-items:center; gap:12px; padding:16px; }
.brand .title{ font-weight:700; font-size:1rem; }
.collapsed .brand .title { display:none; }
nav{ padding:8px 10px; flex:1; overflow:auto; }
.nav-item{ display:flex; align-items:center; gap:12px; padding:10px; border-radius:8px; color:#334155; margin:6px 4px; cursor:pointer; }
.nav-item:hover{ background:#f1f5f9; }
.nav-item .icon{ width:36px; height:36px; display:flex; align-items:center; justify-content:center; border-radius:8px; background:#f8fafc; }
.collapsed .nav-item .label { display:none; }
.nav-item .tooltip{ display:none; position:absolute; left:calc(var(--sidebar-collapsed-w) + 12px); transform:translateX(8px); background:#0b1220; color:white; padding:6px 10px; border-radius:6px; box-shadow:0 6px 20px rgba(2,6,23,0.2); white-space:nowrap; z-index:1200; font-size:0.9rem; }
.sidebar-footer{ padding:12px; border-top:1px solid #eef2f7; background:transparent; }
.collapsed .sidebar-footer .support-text { display:none; }
.main { flex:1; display:flex; flex-direction:column; min-height:100vh; }
.header{ display:flex; align-items:center; justify-content:space-between; padding:14px 18px; border-bottom:1px solid #eef2f7; background:white; z-index:800; }
.header .left { display:flex; align-items:center; gap:12px; }
.hamburger{ display:none; padding:8px; border-radius:8px; }
.content{ padding:18px; flex:1; overflow:auto; padding-bottom:80px; } 
.grid{ display:grid; grid-template-columns:1fr; gap:18px; }
@media(min-width:1024px){ .grid{ grid-template-columns: 2fr 1fr; } }
/* Professional Polish: Add shadow to cards for depth */
.card{ background:white; border:1px solid #eef2f7; border-radius:10px; padding:16px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
.overlay{ position:fixed; inset:0; background:rgba(2,6,23,0.45); display:none; z-index:900; }
.overlay.show{ display:block; }
@media(max-width:768px){
  aside{ position:fixed; left:-320px; top:0; height:100vh; box-shadow:8px 18px 60px rgba(2,6,23,0.2); }
  aside.open{ left:0; }
  .hamburger{ display:inline-flex; }
  .brand .title{ display:inline-block; }
  .collapsed{ width:var(--sidebar-w); min-width:var(--sidebar-w); } 
  .overlay{ display:none; }
  .overlay.show{ display:block; }
}
@media(min-width:769px) and (max-width:1024px){
  .collapsed aside .nav-item .tooltip{ display:block; opacity:0; transition:opacity .12s ease; pointer-events:none; }
  .collapsed aside .nav-item:hover .tooltip{ opacity:1; pointer-events:auto; }
}
.stat-grid{ display:grid; grid-template-columns:1fr; gap:12px; }
@media(min-width:640px){ .stat-grid{ grid-template-columns:repeat(3,1fr); } }
.table{ width:100%; border-collapse:collapse; }
.table th, .table td{ padding:12px 8px; text-align:left; border-bottom:1px solid #f1f5f9; }
.modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:2000; background:rgba(2,6,23,0.45); }
.modal.open{ display:flex; }
.modal .modal-card{ width:100%; max-width:720px; border-radius:12px; padding:18px; background:white; }
.btn { padding:10px 14px; border-radius:8px; cursor:pointer; border:1px solid transparent; }
.btn-primary{ background:var(--primary,#007BFF); color:white; border-color:var(--primary,#007BFF); }
.btn-outline{ background:transparent; border-color:#e6eef8; color:#0f172a; }
.form-row { margin-bottom: 15px; }
.input-field { width:100%;padding:10px 12px;box-sizing: border-box;border-radius:8px;border:1px solid #ccc;font-size:1em;outline: none;transition: border-color 0.3s; }
.input-field:focus {border-color: #4a4aed;}
.close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #64748b; padding: 0; }
.close-btn:hover { color: #0f172a; }

/* üîê Auth-Specific Styles (REWRITTEN FOR PROFESSIONAL LOOK) */
.auth-modal-card { 
    position: relative;
    width: 320px; /* Matched the preferred size */
    padding: 35px 30px !important; 
    border-radius: 25px; /* Smoother border */
    background: rgba(255, 255, 255, var(--card-bg-opacity)); /* Glassmorphism base */
    border: 1px solid var(--shadow-light);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    box-shadow: 0 10px 40px var(--shadow-dark), 0 0 0 1px var(--shadow-light);
    transition: all 0.3s ease;
    z-index: 1001; /* Ensure modal is above backdrop */
}
.auth-modal-card:hover {
    transform: translateY(-3px); 
}
.auth-modal-card .close-btn { 
    position: absolute; 
    top: 15px; 
    right: 20px;
    font-size: 1.5rem;
    color: #aaa;
}

/* Auth Logo Area */
.auth-brand {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 25px;
}
.auth-brand-logo {
    width: 50px;
    height: 50px;
    background: transparent;
    border-radius: 12px; /* Changed from 50% for image */
    box-shadow: none;
    overflow: hidden;
    padding: 0;
}
.auth-brand-logo img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%; /* Image border radius to make it round if needed */
}
.auth-brand-title {
    margin-top: 8px;
    font-size: 14px;
    color: var(--primary);
    font-weight: 600;
}

/* Form Styling */
.auth-modal-card h3 {
    font-size: 20px;
    font-weight: 600;
    color: #333;
    text-align: center;
    margin-bottom: 30px;
}
.form-row {
    margin-bottom: 20px;
    text-align: left;
}
.form-row label {
    display: block;
    font-size: 13px;
    color: #666;
    margin-bottom: 5px;
    font-weight: 600;
}
.input-wrapper {
    position: relative;
}
.custom-input {
    width: 100%;
    padding: 12px 15px;
    padding-right: 40px; /* Space for icon */
    border: 1px solid #ddd;
    border-radius: 10px;
    background-color: var(--white);
    font-size: 14px;
    color: #333;
    transition: all 0.3s ease;
    box-sizing: border-box;
}
.custom-input:focus {
    outline: none;
    border-color: var(--main-color);
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.2);
}
.input-wrapper .input-icon {
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: #aaa;
    pointer-events: none;
    font-size: 18px;
}
.input-wrapper .password-toggle-icon {
    pointer-events: auto;
    cursor: pointer;
    font-variation-settings:'FILL' 0,'wght' 400,'GRAD' 0,'opsz'20; /* Smaller Material Icon for input */
}

/* Login/Signup Button (Gradient) */
.gradient-btn {
    width: 100%;
    padding: 12px;
    margin-top: 15px;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    font-weight: 700;
    color: var(--white);
    cursor: pointer;
    background: linear-gradient(to right, #4facfe, #00f2fe);
    box-shadow: 0 4px 15px rgba(0, 242, 254, 0.4);
    transition: all 0.3s ease;
}
.gradient-btn:hover {
    box-shadow: 0 6px 20px rgba(0, 242, 254, 0.6);
    transform: translateY(-2px);
}
.auth-switch-link {
    text-align: center;
    margin-top: 25px;
    font-size: 14px;
    color: #888;
}
.auth-switch-link a {
    color: var(--main-color);
    text-decoration: none;
    font-weight: 600;
    transition: color 0.2s ease;
}
.auth-switch-link a:hover {
    color: #0056b3;
}
.error-message {
    color: var(--danger);
    font-size: 0.9rem;
    margin-top: 10px;
    font-weight: 500;
    text-align: center;
}

/* Background blob/element for subtle depth */
.background-blob {
    position: fixed;
    top: 50%;
    left: 50%;
    width: 400px;
    height: 400px;
    background: linear-gradient(135deg, #a8ff78, #78ffd6);
    border-radius: 50%;
    filter: blur(80px);
    opacity: 0.6;
    transform: translate(-50%, -50%);
    z-index: 0;
    pointer-events: none;
}


/* ‚≠ê Profile Dropdown Styles (Unchanged for Avatar) ‚≠ê */
.profile-container {
    position: relative;
}
.avatar {
    width: 40px;
    height: 40px;
    background-color: #f1f5f9; /* Light background if image fails to load */
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    user-select: none;
    cursor: pointer; 
    transition: box-shadow 0.2s;
    overflow: hidden; 
    border: 2px solid #007BFF; 
}
.avatar:hover {
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.5);
}
.avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.profile-menu {
    position: absolute;
    top: 50px; 
    right: 0;
    width: 220px;
    background: white;
    border: 1px solid #eef2f7;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    padding: 10px;
    display: none;
    z-index: 1500;
}
.profile-menu.show {
    display: block;
}
.profile-info {
    padding: 8px 10px;
    border-bottom: 1px solid #f1f5f9;
    margin-bottom: 8px;
}
.profile-info .name {
    font-weight: 600;
    font-size: 0.95rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.profile-info .email {
    font-size: 0.8rem;
    color: #64748b;
    word-break: break-all;
}
.profile-menu button {
    width: 100%;
    text-align: left;
    background: none;
    border: none;
    color: var(--danger);
    padding: 8px 10px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
}
.profile-menu button:hover {
    background: #fee2e2;
}

/* ‚≠ê Banner Indicator Styles (Unchanged) ‚≠ê */
.banner-indicator-container {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-top: 10px;
    margin-bottom: -4px;
}
.banner-indicator {
    width: 10px;
    height: 10px;
    background-color: #cbd5e1;
    border-radius: 50%;
    cursor: pointer;
    transition: background-color 0.3s, transform 0.3s;
}
.banner-indicator.active {
    background-color: #007BFF;
    transform: scale(1.1);
}
</style>
</head>
<body class="font-display bg-background-light">

<div class="app" id="appRoot" style="display:none;">
  <div id="mobileOverlay" class="overlay" onclick="closeMobile()"></div>
  <aside id="sidebar" class="" aria-label="Main navigation">
    <div class="brand">
      <div class="logo"><img src="https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg" alt="logo" style="width:22px;height:22px;"/></div>
      <div class="title">TG Group Exchange</div>
      <button id="collapseBtn" title="Collapse sidebar" style="margin-left:auto;background:none;border:0;padding:6px;border-radius:8px;cursor:pointer;"><span class="material-symbols-outlined">chevron_left</span></button>
    </div>

    <nav id="navList">
      <div class="nav-item" data-title="Dashboard" tabindex="0">
        <div class="icon"><span class="material-symbols-outlined">dashboard</span></div>
        <div class="label">Dashboard</div>
        <div class="tooltip">Dashboard</div>
      </div>
      <div class="nav-item" data-title="Sell Group" tabindex="0" onclick="openModal('sellModal')">
        <div class="icon"><span class="material-symbols-outlined">sell</span></div>
        <div class="label">Sell Group</div>
        <div class="tooltip">Sell Group</div>
      </div>
      <div class="nav-item" data-title="Withdraw" tabindex="0" onclick="openModal('withdrawModal')">
        <div class="icon"><span class="material-symbols-outlined">account_balance_wallet</span></div>
        <div class="label">Withdraw</div>
        <div class="tooltip">Withdraw</div>
      </div>
      <div class="nav-item" data-title="Records" tabindex="0" onclick="openModal('recordsModal')">
        <div class="icon"><span class="material-symbols-outlined">receipt_long</span></div>
        <div class="label">Records</div>
        <div class="tooltip">Records</div>
      </div>
      <!-- MODIFIED: Added onclick to open new modal -->
      <div class="nav-item" data-title="How it works" tabindex="0" onclick="openModal('howItWorksModal')">
        <div class="icon"><span class="material-symbols-outlined">help_center</span></div>
        <div class="label">How it works</div>
        <div class="tooltip">How it works</div>
      </div>
    </nav>

    <div class="sidebar-footer">
      <div style="padding:10px;">
        <div style="display:flex;align-items:center;gap:10px;">
          <img src="https://i.ibb.co/BMdH2fz/Pngtree-customer-support-agent-at-work-19770230.png" alt="support" style="width:44px;height:44px;border-radius:8px;object-fit:cover;"/>
          <div style="flex:1;">
            <div style="font-weight:700;">Need Help?</div>
            <div class="support-text" style="font-size:12px;color:#64748b;">Contact support for questions</div>
          </div>
        </div>
        <div style="margin-top:8px;">
          <button id="contactBtn" class="btn btn-primary" style="width:100%;">Contact Support</button>
        </div>
      </div>
    </div>
  </aside>

  <div class="main">
    <header class="header">
      <div class="left">
        <button id="mobileOpenBtn" class="hamburger" aria-label="Open menu"><span class="material-symbols-outlined">menu</span></button>
        <div>
          <div style="font-weight:700;">Dashboard</div>
          <div style="font-size:13px;color:#64748b;" id="welcomeMessage">Welcome!</div>
        </div>
      </div>
      <!-- ‚≠ê UPDATED: User Info with clickable Avatar Image and Dropdown ‚≠ê -->
      <div class="profile-container" id="userDropdown">
        <!-- Avatar Image -->
        <div class="avatar" onclick="toggleProfileMenu()" id="avatarDisplay">
            <!-- UPDATED AVATAR IMAGE URL -->
            <img src="https://i.ibb.co/WN9fFRDc/Download-Profile-image-of-man-avatar-for-social-networks-with-half-circle-Fashion-vector-Bright-vect.jpg" 
                 alt="Profile Avatar" id="avatarImage"> 
        </div>
        
        <!-- Profile Menu Dropdown -->
        <div id="profileMenu" class="profile-menu">
            <div class="profile-info">
                <div class="name" id="profileUserName">Guest</div>
                <div class="email" id="profileUserEmail">Sign in to view details</div>
            </div>
            <!-- Auth Action Button (Login/Signup/Logout) -->
            <button id="authAction" onclick="signOutUser()">Login / Signup</button>
        </div>
      </div>
      <!-- ‚≠ê END OF UPDATED USER INFO ‚≠ê -->
    </header>

    <main class="content">
      <div class="content-inner">
        <div class="grid">
          <div>
            <!-- START OF BANNER CAROUSEL CONTAINER -->
            <div id="bannerCarousel">
                <!-- Banner 1: TG - Exchange (UPDATED URL) -->
                <div id="welcomeBanner" class="card" style="padding:0; border:none; background:transparent; overflow:hidden;">
                    <!-- WELCOME BANNER IMAGE -->
                    <img src="https://i.ibb.co/BHCP2bWk/file-000000003c9c7206b892d0c6e3a00209.png" 
                         alt="Welcome to TG Exchange Banner" 
                         style="width:100%; border-radius:10px; display:block; margin:0;">
                </div>
                
                <!-- Banner 2: Agent System Rewards - Initialy Hidden (UPDATED URL) -->
                <div id="agentBanner" class="card" style="padding:0; border:none; background:transparent; overflow:hidden; display:none;">
                    <!-- AGENT SYSTEM REWARDS BANNER -->
                    <img src="https://i.ibb.co/YTkcb6KC/1763952175960.png" 
                         alt="Agent System Rewards Banner" 
                         style="width:100%; border-radius:10px; display:block; margin:0;">
                </div>

                 <!-- Banner 3: New Third Banner - Initialy Hidden -->
                <div id="thirdBanner" class="card" style="padding:0; border:none; background:transparent; overflow:hidden; display:none;">
                    <!-- THIRD BANNER IMAGE -->
                    <img src="https://i.ibb.co/wr4HbF6x/file-0000000016c071faa17d6fbf667e370b.png" 
                         alt="Third Rotating Banner" 
                         style="width:100%; border-radius:10px; display:block; margin:0;">
                </div>
            </div>
            <!-- END OF BANNER CAROUSEL CONTAINER -->
            
            <!-- ‚≠ê NEW: Banner Indicators Container ‚≠ê -->
            <div id="bannerIndicators" class="banner-indicator-container">
                <div class="banner-indicator active" data-index="0"></div>
                <div class="banner-indicator" data-index="1"></div>
                <div class="banner-indicator" data-index="2"></div>
            </div>
            <!-- ‚≠ê END OF NEW INDICATORS ‚≠ê -->

            <div style="height:14px;"></div>

            <div class="card">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                <div style="font-weight:700;">Today's Summary</div>
              </div>
              <div class="stat-grid">
                <div class="card" style="display:flex;gap:12px;align-items:center;">
                  <div style="padding:10px;border-radius:8px;background:#ecfeef;"><span class="material-symbols-outlined">trending_up</span></div>
                  <div>
                    <div style="font-size:12px;color:#64748b;">Total Sold Groups</div>
                    <div style="font-weight:700;font-size:20px;" id="totalSold">0</div>
                  </div>
                </div>

                <div class="card" style="display:flex;gap:12px;align-items:center;">
                  <div style="padding:10px;border-radius:8px;background:#eef2ff;"><span class="material-symbols-outlined">payments</span></div>
                  <div>
                    <div style="font-size:12px;color:#64748b;">Balance (USDT)</div>
                    <div style="font-weight:700;font-size:20px;" id="balance">0.00</div>
                  </div>
                </div>

                <div class="card" style="display:flex;gap:12px;align-items:center;">
                  <div style="padding:10px;border-radius:8px;background:#fff7ed;"><span class="material-symbols-outlined">hourglass_top</span></div>
                  <div>
                    <div style="font-size:12px;color:#64748b;">Pending</div>
                    <div style="font-weight:700;font-size:20px;" id="pending">0</div>
                  </div>
                </div>
              </div>
            </div>

            <div style="height:12px;"></div>

            <div class="card">
              <div style="font-weight:700;margin-bottom:8px;">Task List (Orders)</div>
              <div style="overflow:auto;">
                <table class="table" role="table" aria-label="Tasks">
                  <!-- MODIFIED: New table headers -->
                  <thead><tr><th>Task</th><th>Amount of Groups</th><th>Transfer Group Owner</th><th>Status</th></tr></thead>
                  <tbody id="taskBody"><tr><td colspan="4" style="padding:24px;text-align:center;color:#64748b;">Loading Orders...</td></tr></tbody>
                </table>
              </div>
            </div>
          </div>

          <div>
            <div class="card" style="margin-bottom:12px;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                <div style="font-weight:700;">Quick Actions</div>
                <div style="background:#ecfdf5;padding:6px 8px;border-radius:999px;color:#065f46;font-weight:600;font-size:12px;"><span class="material-symbols-outlined" style="vertical-align:middle;">verified_user</span> Secure</div>
              </div>
              <div style="display:flex;flex-direction:column;gap:8px;">
                <button class="btn btn-outline" onclick="openModal('sellModal')">Create Sell Order</button>
                <button class="btn btn-primary" onclick="openModal('withdrawModal')">Withdraw Funds</button>
                <button class="btn btn-outline" onclick="openModal('recordsModal')">View Records</button>
              </div>
            </div>

            <div class="card">
              <div style="font-weight:700;margin-bottom:8px;">Price List</div>
              <div style="overflow:auto;">
                <table class="table" role="table" aria-label="Prices">
                  <thead><tr><th>#</th><th>Year/Period</th><th style="text-align:right;">Price (USDT)</th></tr></thead>
                  <!-- START OF UPDATED PRICE LIST -->
                  <tbody>
                    <tr><td style="color:#64748b;">1</td><td>2024 (10~10)</td><td style="text-align:right;font-weight:700;">0.50</td></tr>
                    <tr><td style="color:#64748b;">2</td><td>2024 (08~08)</td><td style="text-align:right;font-weight:700;">0.80</td></tr>
                    <tr><td style="color:#64748b;">3</td><td>2024 (07~07)</td><td style="text-align:right;font-weight:700;">1.50</td></tr>
                    <tr><td style="color:#64748b;">4</td><td>2024 (06~06)</td><td style="text-align:right;font-weight:700;">3.20</td></tr>
                    <tr><td style="color:#64748b;">5</td><td>2024 (05~05)</td><td style="text-align:right;font-weight:700;">4.13</td></tr>
                    <tr><td style="color:#64748b;">6</td><td>2024 (04~04)</td><td style="text-align:right;font-weight:700;">5.40</td></tr>
                    <tr><td style="color:#64748b;">7</td><td>2024 (03~03)</td><td style="text-align:right;font-weight:700;">6.50</td></tr>
                    <tr><td style="color:#64748b;">8</td><td>2024 (02~02)</td><td style="text-align:right;font-weight:700;">6.50</td></tr>
                    <tr><td style="color:#64748b;">9</td><td>2024 (01~01)</td><td style="text-align:right;font-weight:700;">6.50</td></tr>
                    <tr><td style="color:#64748b;">10</td><td>2023</td><td style="text-align:right;font-weight:700;">10.24</td></tr>
                    <tr><td style="color:#64748b;">11</td><td>2022</td><td style="text-align:right;font-weight:700;">13.50</td></tr>
                    <tr><td style="color:#64748b;">12</td><td>2021</td><td style="text-align:right;font-weight:700;">13.50</td></tr>
                    <tr><td style="color:#64748b;">13</td><td>2020</td><td style="text-align:right;font-weight:700;">13.50</td></tr>
                    <tr><td style="color:#64748b;">14</td><td>2019</td><td style="text-align:right;font-weight:700;">13.70</td></tr>
                    <tr><td style="color:#64748b;">15</td><td>2018</td><td style="text-align:right;font-weight:700;">14.00</td></tr>
                    <tr><td style="color:#64748b;">16</td><td>2017</td><td style="text-align:right;font-weight:700;">14.00</td></tr>
                    <tr><td style="color:#64748b;">17</td><td>2016</td><td style="text-align:right;font-weight:700;">14.00</td></tr>
                  </tbody>
                  <!-- END OF UPDATED PRICE LIST -->
                </table>
              </div>
            </div>

          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- üîê Sign Up Modal (REWRITTEN FOR PROFESSIONAL LOOK) -->
<div id="signupModal" class="modal" aria-hidden="true"> 
  <!-- Background Blob for Visual Effect -->
  <div class="background-blob"></div>

  <div class="modal-card auth-modal-card">
    <button aria-label="Close modal" class="close-btn" onclick="closeModal('signupModal')">√ó</button>

    <div class="auth-brand">
      <div class="auth-brand-logo">
        <!-- UPDATED LOGIN/SIGNUP LOGO IMAGE -->
        <img src="https://i.ibb.co/3XJLppF/1763813199426.png" alt="Logo">
      </div>
      <div class="auth-brand-title">TG-exchange</div>
    </div>
    
    <h3>Create Your Account</h3>
    
    <form id="signupForm">
      <div class="form-row">
        <label>Telegram Username</label>
        <div class="input-wrapper">
            <input id="m_signupTelegram" type="text" placeholder="@yourusername" required class="custom-input">
            <span class="material-symbols-outlined input-icon">alternate_email</span>
        </div>
      </div>
      <div class="form-row">
        <label>Email</label>
        <div class="input-wrapper">
            <input id="m_signupEmail" type="email" placeholder="your.email@example.com" required class="custom-input">
            <span class="material-symbols-outlined input-icon">mail</span>
        </div>
      </div>
      <div class="form-row">
        <label>Password</label>
        <div class="input-wrapper">
            <input id="m_signupPassword" type="password" placeholder="Min 6 characters" required class="custom-input">
            <span class="material-symbols-outlined input-icon password-toggle-icon" onclick="togglePassword('m_signupPassword', this)">visibility_off</span>
        </div>
      </div>
      <div class="form-row">
        <label>Confirm Password</label>
        <div class="input-wrapper">
            <input id="m_signupConfirmPassword" type="password" placeholder="Re-enter password" required class="custom-input">
            <span class="material-symbols-outlined input-icon password-toggle-icon" onclick="togglePassword('m_signupConfirmPassword', this)">visibility_off</span>
        </div>
      </div>
      <div id="signupError" class="error-message"></div>
      <div>
        <button type="submit" class="gradient-btn">Sign Up</button>
      </div>
    </form>
    <p class="auth-switch-link">
        Already have an account? 
        <a href="#" onclick="closeModal('signupModal'); openModal('loginModal'); return false;">
            Login here
        </a>
    </p>
  </div>
</div>

<!-- üîê Login Modal (REWRITTEN FOR PROFESSIONAL LOOK) -->
<div id="loginModal" class="modal" aria-hidden="true">
  <!-- Background Blob for Visual Effect -->
  <div class="background-blob"></div>

  <div class="modal-card auth-modal-card">
    <button aria-label="Close modal" class="close-btn" onclick="closeModal('loginModal')">√ó</button>

    <div class="auth-brand">
      <div class="auth-brand-logo">
        <!-- UPDATED LOGIN/SIGNUP LOGO IMAGE -->
        <img src="https://i.ibb.co/3XJLppF/1763813199426.png" alt="Logo">
      </div>
      <div class="auth-brand-title">TG-exchange</div>
    </div>
    
    <h3>Login to Account</h3>
    
    <form id="loginForm">
      <div class="form-row">
        <label>Email</label>
        <div class="input-wrapper">
            <input id="m_loginEmail" type="email" placeholder="your.email@example.com" required class="custom-input">
            <span class="material-symbols-outlined input-icon">mail</span>
        </div>
      </div>
      <div class="form-row">
        <label>Password</label>
        <div class="input-wrapper">
            <input id="m_loginPassword" type="password" placeholder="Enter your password" required class="custom-input">
            <span class="material-symbols-outlined input-icon password-toggle-icon" onclick="togglePassword('m_loginPassword', this)">visibility_off</span>
        </div>
      </div>
      <div id="loginError" class="error-message"></div>
      <div>
        <button type="submit" class="gradient-btn">Login</button>
      </div>
    </form>
    <p class="auth-switch-link">
        Need an account? 
        <a href="#" onclick="closeModal('loginModal'); openModal('signupModal'); return false;">
            Sign Up
        </a>
    </p>
  </div>
</div>


<!-- ‚≠ê UPDATED SELL ORDER MODAL matching the screenshot ‚≠ê -->
<div id="sellModal" class="modal" aria-hidden="true">
  <div class="modal-card card" style="max-width:450px;">
    <div style="display:flex;justify-content:space-between;align-items:center; margin-bottom: 5px;">
      <div style="font-weight:700; font-size: 1.25rem;">Create order</div>
      <button onclick="closeModal('sellModal')" class="close-btn" aria-label="Close modal">√ó</button>
    </div>
    
    <form id="sellForm">
      <!-- Task Name Field -->
      <div class="form-row">
        <label style="font-weight: 600; margin-bottom: 4px; display: block;">Task Name</label>
        <input id="m_taskName" class="input-field" placeholder="Enter your Group Year " required>
      </div>

      <!-- Invite Link Type Radio Buttons -->
      <div class="form-row" style="margin-bottom: 20px;">
        <label style="font-weight: 600; margin-bottom: 8px; display: block;">Invite Link Type</label>
        <div style="display:flex; gap: 25px;">
            <label style="display: flex; align-items: center; gap: 6px; font-weight: 400; cursor: pointer;">
                <input type="radio" name="inviteLinkType" value="Single" checked class="text-primary focus:ring-primary" style="accent-color: #6D28D9; border-color: #d1d5db; width: 18px; height: 18px; line-height: 1;">
                Single
            </label>
            <label style="display: flex; align-items: center; gap: 6px; font-weight: 400; cursor: pointer;">
                <input type="radio" name="inviteLinkType" value="Folder" class="text-primary focus:ring-primary" style="accent-color: #6D28D9; border-color: #d1d5db; width: 18px; height: 18px; line-height: 1;">
                Folder
            </label>
        </div>
      </div>
      
      <!-- Group Link Textarea -->
      <div class="form-row">
        <label style="font-weight: 600; margin-bottom: 4px; display: block;">Group link</label>
        <textarea id="m_groupLinks" class="input-field" rows="4" placeholder="Enter group links, one per line." required></textarea>
      </div>
      
      <div id="sellError" class="error-message"></div>
      
      <!-- Buttons -->
      <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:20px;">
        <button type="button" class="btn btn-outline" style="background: white; border-color: #d1d5db; color: #4b5563; font-weight:500;" onclick="closeModal('sellModal')">Cancel</button>
        <button type="submit" class="btn" style="background: #6D28D9; color: white; font-weight:600; border: 1px solid #6D28D9;">Submit</button>
      </div>
    </form>
  </div>
</div>
<!-- ‚≠ê END OF UPDATED SELL ORDER MODAL ‚≠ê -->


<!-- üí∞ UPDATED WITHDRAW MODAL matching the new design üí∞ -->
<div id="withdrawModal" class="modal" aria-hidden="true">
  <div class="modal-card card" style="max-width:340px; padding: 20px;">
    
    <!-- Modal Header -->
    <div style="display:flex;justify-content:space-between;align-items:center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px;">
      <div style="font-weight:700; font-size: 1.2em;">Withdraw</div>
      <button onclick="closeModal('withdrawModal')" class="close-btn" aria-label="Close modal" style="font-size: 1.5em; color: #aaa;">√ó</button>
    </div>
    
    <form id="withdrawForm">
        <!-- Wallet Type Radio Group -->
        <div class="form-row">
            <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: #333; font-weight: 500;">
                Please import your withdraw
                <span style="color:red; margin-left: 2px;">*</span>
            </label>
            <div style="display: flex; gap: 20px; margin-top: 5px;">
                <!-- TRC20 Radio -->
                <label style="display: flex; align-items: center; gap: 6px; font-weight: 400; cursor: pointer;">
                    <input type="radio" id="trc20" name="wallet_type" value="TRC20" checked class="text-primary focus:ring-primary" style="accent-color: #4a4aed; border-color: #ccc; width: 16px; height: 16px;">
                    TRC20
                </label>
                <!-- Binance Radio -->
                <label style="display: flex; align-items: center; gap: 6px; font-weight: 400; cursor: pointer;">
                    <input type="radio" id="binance" name="wallet_type" value="Binance" class="text-primary focus:ring-primary" style="accent-color: #4a4aed; border-color: #ccc; width: 16px; height: 16px;">
                    Binance
                </label>
            </div>
        </div>

        <!-- Amount Input -->
        <div class="form-row">
            <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: #333; font-weight: 500;">
                Please enter the amount
                <span style="color:red; margin-left: 2px;">*</span>
            </label>
            <input id="m_withdrawAmount" class="input-field" type="number" placeholder="Please enter the amount" min="1" step="0.01" required>
        </div>
        
        <!-- Wallet Address Input -->
        <div class="form-row">
            <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: #333; font-weight: 500;">
                Wallet
                <span style="color:red; margin-left: 2px;">*</span>
            </label>
            <input id="m_withdrawAddress" class="input-field" type="text" placeholder="Please input your Wallet!" required>
        </div>

        <div id="withdrawError" class="error-message"></div>
        
        <!-- Buttons -->
        <div style="display:flex;justify-content:flex-end;gap:10px;padding-top:10px; margin-top: 10px;">
            <button type="button" class="btn" style="background-color: #f0f0f0; color: #333; font-weight: bold; padding: 10px 15px; border-radius: 5px;" onclick="closeModal('withdrawModal')">Cancel</button>
            <button type="submit" class="btn" style="background-color: #4a4aed; color: white; font-weight: bold; padding: 10px 15px; border-radius: 5px;">Confirm</button>
        </div>
    </form>
  </div>
</div>
<!-- üí∞ END OF UPDATED WITHDRAW MODAL üí∞ -->


<div id="recordsModal" class="modal" aria-hidden="true">
  <div class="modal-card card">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div style="font-weight:700;">Transaction Records</div>
      <button onclick="closeModal('recordsModal')" class="btn">‚úï</button>
    </div>
    <div style="margin-top:12px;">
      <div style="overflow:auto;">
        <table class="table">
          <thead><tr><th>Date</th><th>Type</th><th>Amount (USDT)</th></tr></thead>
          <tbody id="recordsBody"><tr><td colspan="3" style="padding:18px;text-align:center;color:#64748b;">No records yet</td></tr></tbody>
        </table>
      </div>
      <div style="text-align:right;margin-top:10px;"><button class="btn" onclick="closeModal('recordsModal')">Close</button></div>
    </div>
  </div>
</div>

<div id="contactModal" class="modal" aria-hidden="true">
  <div class="modal-card card">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div style="font-weight:700;">Contact Support</div>
      <button onclick="closeModal('contactModal')" class="close-btn" aria-label="Close modal">√ó</button>
    </div>
    <form id="contactForm" style="margin-top:12px;">
      <label style="display: block; margin-bottom: 4px; font-weight: 600;">Name</label><input id="c_name" class="input-field" required>
      <label style="display: block; margin-top:8px; margin-bottom: 4px; font-weight: 600;">Email</label><input id="c_email" class="input-field" type="email" required>
      <label style="display: block; margin-top:8px; margin-bottom: 4px; font-weight: 600;">Message</label><textarea id="c_msg" class="input-field" rows="3" required></textarea>
      <div id="contactError" class="error-message"></div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px;">
        <button type="button" class="btn btn-outline" onclick="closeModal('contactModal')">Cancel</button>
        <button type="submit" class="btn btn-primary">Send</button>
      </div>
    </form>
  </div>
</div>

<!-- ‚ùì How It Works Modal (NEW) -->
<div id="howItWorksModal" class="modal" aria-hidden="true">
  <div class="modal-card card" style="max-width:720px;">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div style="font-weight:700; font-size: 1.25rem;">How to Sell Your Telegram Group</div>
      <button onclick="closeModal('howItWorksModal')" class="close-btn" aria-label="Close modal">√ó</button>
    </div>
    
    <div style="margin-top:15px;">
      <!-- Content from the second file -->
      <img class="section-img"
           src="https://i.ibb.co/gFMBrkjZ/up-Grad-y-Clever-Tap-Domina-el-Marketing-Digital.jpg"
           alt="Instruction Image">

      <div class="section-text">
        <ol>
          <li>You must be the <strong>actual owner/creator</strong> of the Telegram group.</li>
          <li>The group must be a <strong>Private Group</strong>.</li>
          <li>‚ÄúChat History for New Members‚Äù must be <strong>enabled</strong>.</li>
          <li>The group's <strong>creation year</strong> must match our price list.</li>
          <li>Send the <strong>Invite Link</strong> of the group for verification.</li>
          <li>Transfer the group <strong>ownership</strong> to our agent.</li>
          <li>Our team will review and check the group's condition.</li>
          <li>If approved, you‚Äôll receive payment in <strong>USDT</strong>.</li>
        </ol>
      </div>
      
      <div style="text-align:right; margin-top:20px;">
        <button class="btn btn-primary" onclick="closeModal('howItWorksModal')">Understood</button>
      </div>
    </div>
  </div>
</div>
<!-- ‚ùì END OF How It Works Modal -->

<script>
// ===============================================
// üî• 2. FIREBASE CONFIG (USER PROVIDED - REAL KEYS)
// ===============================================
const firebaseConfig = {
    apiKey: "AIzaSyAdigwBY3np6j8RzwxYRlrMcBJG3wsiwaE", // <-- ‡§Ü‡§™‡§ï‡•Ä ‡§Ö‡§∏‡§≤‡•Ä API Key
    authDomain: "tg-grou---exchange-d85cb.firebaseapp.com",
    databaseURL: "https://tg-grou---exchange-d85cb-default-rtdb.firebaseio.com",
    projectId: "tg-grou---exchange-d85cb",
    storageBucket: "tg-grou---exchange-d85cb.firebasestorage.app",
    messagingSenderId: "578882291833",
    appId: "1:578882291833:web:4984927a8c0dc5fce16ca8",
    measurementId: "G-NFVF65KMVY"
};

if (firebase.apps.length === 0) {
    firebase.initializeApp(firebaseConfig);
}
const auth = firebase.auth(); 
const db = firebase.database();
let currentUserId = null; 
let currentBalance = 0; 
let currentTelegramUsername = 'Guest'; // Store username globally for use in contact form
let currentUserEmail = 'Sign in to view details'; // NEW: Store user email


/* App state & UI references */
const sidebar = document.getElementById('sidebar');
const appRoot = document.getElementById('appRoot');
const mobileOverlay = document.getElementById('mobileOverlay');
const collapseBtn = document.getElementById('collapseBtn');
const mobileOpenBtn = document.getElementById('mobileOpenBtn');
const contactBtn = document.getElementById('contactBtn');
// Profile Dropdown references
const profileMenu = document.getElementById('profileMenu');
const avatarDisplay = document.getElementById('avatarDisplay');
const profileUserName = document.getElementById('profileUserName');
const profileUserEmail = document.getElementById('profileUserEmail');
const avatarImage = document.getElementById('avatarImage');
// Banner references for Carousel
const welcomeBanner = document.getElementById('welcomeBanner');
const agentBanner = document.getElementById('agentBanner');
const thirdBanner = document.getElementById('thirdBanner');
const banners = [welcomeBanner, agentBanner, thirdBanner].filter(b => b); // Filter out nulls
const indicatorContainer = document.getElementById('bannerIndicators');
let currentBannerIndex = 0;


/* UI Functions (Collapse, Modals, Banner Toggle) */
function setCollapsed(val){ 
    let collapsed = val; 
    if(collapsed) { 
        sidebar.classList.add('collapsed'); 
    } else { 
        sidebar.classList.remove('collapsed'); 
    } 
}
collapseBtn.addEventListener('click', () => { 
    // Toggle collapse only on desktop
    if(window.innerWidth > 1024) { 
        const isCollapsed = sidebar.classList.contains('collapsed');
        setCollapsed(!isCollapsed);
    } else {
        closeMobile(); 
    }
});

function closeMobile(){ sidebar.classList.remove('open'); mobileOverlay.classList.remove('show'); }
mobileOpenBtn.addEventListener('click', () => { sidebar.classList.add('open'); mobileOverlay.classList.add('show'); });
mobileOverlay.addEventListener('click', closeMobile);
contactBtn.addEventListener('click', () => openModal('contactModal'));
function openModal(id){ 
    const m = document.getElementById(id); 
    if(!m) return; 
    m.classList.add('open'); 
    m.setAttribute('aria-hidden','false'); 
    document.body.style.overflow = 'hidden'; 
    // Clear error message when opening modal
    const errorId = id.replace('Modal', 'Error');
    const errorEl = document.getElementById(errorId);
    if(errorEl) errorEl.textContent = '';
}
function closeModal(id){ 
    const m = document.getElementById(id); 
    if(!m) return; 
    m.classList.remove('open'); 
    m.setAttribute('aria-hidden','true'); 
    document.body.style.overflow = ''; 
}

// NEW: Function to toggle profile dropdown
function toggleProfileMenu() {
    profileMenu.classList.toggle('show');
}
// NEW: Close dropdown if user clicks outside
document.addEventListener('click', function(event) {
    const userDropdown = document.getElementById('userDropdown');
    const isClickInside = userDropdown && userDropdown.contains(event.target);
    if (!isClickInside && profileMenu.classList.contains('show')) {
        profileMenu.classList.remove('show');
    }
});

// NEW: Function to toggle password visibility in modals
function togglePassword(inputId, iconElement) {
    const input = document.getElementById(inputId);
    if (input.type === 'password') {
        input.type = 'text';
        iconElement.textContent = 'visibility'; // Icon for visible
    } else {
        input.type = 'password';
        iconElement.textContent = 'visibility_off'; // Icon for hidden
    }
}


// ===============================================
// üìà 3. REAL-TIME DATA HANDLING & DASHBOARD UPDATES
// ===============================================

// Listener for User Stats (Balance, Sold, Pending)
function setupStatsListener(userId) {
    const statsRef = db.ref(`users/${userId}/stats`);
    statsRef.on('value', (snapshot) => {
        const stats = snapshot.val() || { totalSold: 0, balance: 0.00, pending: 0, telegram: 'User' };
        
        document.getElementById('totalSold').textContent = stats.totalSold || 0;
        document.getElementById('balance').textContent = (stats.balance || 0).toFixed(2);
        document.getElementById('pending').textContent = stats.pending || 0;
        currentBalance = stats.balance || 0;
        
        // Update User Info globally and in header (profile menu now shows details)
        const username = auth.currentUser.email ? auth.currentUser.email.split('@')[0] : 'User'; 
        currentTelegramUsername = stats.telegram || username;
        currentUserEmail = auth.currentUser.email || 'N/A';
        
        profileUserName.textContent = currentTelegramUsername;
        profileUserEmail.textContent = currentUserEmail;
        
        document.getElementById('welcomeMessage').textContent = `Welcome, ${currentTelegramUsername}!`;
    });
}

// MODIFIED: Listener for Task List (Orders) to display new columns
function setupOrdersListener(userId) {
    const ordersRef = db.ref(`users/${userId}/orders`).limitToLast(10);
    ordersRef.on('value', (snapshot) => {
        const orders = snapshot.val();
        const tbody = document.getElementById('taskBody');
        tbody.innerHTML = ''; 

        if (!orders) {
            // Updated colspan to 4 to match the new 4 columns
            tbody.innerHTML = '<tr><td colspan="4" style="padding:24px;text-align:center;color:#64748b;">No active orders found.</td></tr>';
            return;
        }

        Object.keys(orders).reverse().forEach(key => {
            const order = orders[key];
            const transferOwner = order.transferUsername || 'Pending...'; // NEW COLUMN: Transfer Group Owner
            const statusColor = order.status === 'Completed' ? '#28a745' : (order.status === 'Rejected' ? '#dc3545' : '#f97316');
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${order.title}</td>
                <td>${order.amount}</td>
                <td>${transferOwner}</td>
                <td><span style="color:${statusColor};font-weight:600;">${order.status}</span></td>
            `;
            tbody.appendChild(tr);
        });
    });
}

// MODIFIED: Listener for Records (Transactions) to show status instead of +0.00
function setupRecordsListener(userId) {
    const recordsRef = db.ref(`users/${userId}/records`).limitToLast(20);
    recordsRef.on('value', (snapshot) => {
        const records = snapshot.val();
        const rb = document.getElementById('recordsBody');
        rb.innerHTML = ''; 

        if (!records) {
            rb.innerHTML = '<tr><td colspan="3" style="padding:18px;text-align:center;color:#64748b;">No records yet.</td></tr>';
            return;
        }

        Object.keys(records).reverse().forEach(key => {
            const record = records[key];
            const date = new Date(record.timestamp).toLocaleDateString();
            
            let amountDisplayContent;
            let statusColor;

            const amount = Number(record.amount);
            const isMonetary = amount !== 0; // Simplified check for monetary status

            if (isMonetary) {
                // Monetary Transaction
                const sign = amount > 0 ? '+' : '';
                amountDisplayContent = `${sign}${amount.toFixed(2)}`;
                statusColor = amount > 0 ? 'var(--success)' : 'var(--danger)';
            } else {
                // Non-monetary status record (Submission, Rejection with zero amount)
                amountDisplayContent = record.status;
                if(record.status === 'Completed') statusColor = 'var(--success)';
                else if(record.status === 'Rejected') statusColor = 'var(--danger)';
                else statusColor = '#f97316'; // Pending/Submitted
            }

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${date}</td>
                <td>${record.type}</td>
                <td style="color:${statusColor};font-weight:600;">${amountDisplayContent}</td>
            `;
            rb.appendChild(tr);
        });
    });
}

// ============================
// üîê AUTHENTICATION HANDLERS
// ============================

function handleLoginState(user) {
    const authAction = document.getElementById('authAction');
    
    // Cleanup listeners on logout
    if (currentUserId) {
        db.ref(`users/${currentUserId}/stats`).off();
        db.ref(`users/${currentUserId}/orders`).off();
        db.ref(`users/${currentUserId}/records`).off();
    }

    if (user) {
        // Logged In: Show app, hide auth modals
        currentUserId = user.uid;
        appRoot.style.display = 'flex'; 
        closeModal('loginModal'); 
        closeModal('signupModal'); 
        
        // Update Profile Dropdown UI
        const displayName = user.email ? user.email.split('@')[0] : 'User';
        profileUserName.textContent = displayName; // Will be overwritten by stat listener later if telegram exists
        profileUserEmail.textContent = user.email || 'N/A';
        
        // Update Logout button
        authAction.textContent = 'Logout';
        authAction.onclick = signOutUser;

        // Set up real-time data listeners
        setupStatsListener(user.uid);
        setupOrdersListener(user.uid);
        setupRecordsListener(user.uid);

    } else {
        // Logged Out: Hide app, show auth modal
        currentUserId = null;
        appRoot.style.display = 'none'; 
        
        // Reset Profile Dropdown UI
        document.getElementById('welcomeMessage').textContent = 'Welcome!';
        profileUserName.textContent = 'Guest';
        profileUserEmail.textContent = 'Sign in to view details';
        
        profileMenu.classList.remove('show'); // Hide dropdown on logout

        // Update Login/Signup button
        authAction.textContent = 'Login / Signup';
        authAction.onclick = () => { profileMenu.classList.remove('show'); openModal('loginModal'); };

        // Reset global variables
        currentTelegramUsername = 'Guest';
        currentUserEmail = 'Sign in to view details';

        // Initial Flow: Open Signup modal if not logged in
        openModal('signupModal');
    }
}

function signUpUser() {
    const telegramUsername = document.getElementById('m_signupTelegram').value.trim();
    const email = document.getElementById('m_signupEmail').value.trim();
    const password = document.getElementById('m_signupPassword').value;
    const confirmPassword = document.getElementById('m_signupConfirmPassword').value;
    const errorEl = document.getElementById('signupError');
    errorEl.textContent = '';

    if (!telegramUsername || !email || !password || !confirmPassword) { errorEl.textContent = 'Please fill in all fields (‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§≠‡•Ä ‡§´‡§º‡•Ä‡§≤‡•ç‡§° ‡§≠‡§∞‡•á‡§Ç).'; return; }
    if (password.length < 6) { errorEl.textContent = 'Password must be at least 6 characters long.'; return; }
    if (password !== confirmPassword) { errorEl.textContent = 'Password and Confirm Password do not match.'; return; }

    auth.createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
            // After successful creation, the user is automatically logged in.
            // Save initial stats to Realtime Database
            db.ref(`users/${userCredential.user.uid}/stats`).set({
                telegram: telegramUsername, 
                totalSold: 0,
                balance: 0.00,
                pending: 0
            });
            
            document.getElementById('signupForm').reset();
            // handleLoginState will now run automatically and show the dashboard.
        })
        .catch((error) => {
            errorEl.textContent = 'Signup Failed: ' + error.message;
        });
}

function signInUser() {
    const email = document.getElementById('m_loginEmail').value;
    const password = document.getElementById('m_loginPassword').value;
    const errorEl = document.getElementById('loginError');
    errorEl.textContent = '';

    if (!email || !password) { errorEl.textContent = 'Please enter both email and password.'; return; }

    auth.signInWithEmailAndPassword(email, password)
        .then(() => {
            document.getElementById('loginForm').reset();
            // handleLoginState will take over and show the dashboard
        })
        .catch((error) => {
            errorEl.textContent = 'Login Failed: ' + error.message;
        });
}

function signOutUser() {
    auth.signOut()
        .then(() => {
            // Success, handleLoginState will run and show login modal
        })
        .catch((error) => {
            console.error('Logout Failed:', error.message);
        });
}


// ===============================================
// üí∞ 4. TRANSACTION HANDLERS (REAL WORKING)
// ===============================================

// MODIFIED: Create Sell Order - Record amount set to 0 and recordKey saved
function createSell(e){
    e.preventDefault();
    const errorEl = document.getElementById('sellError');
    errorEl.textContent = ''; 

    if(!currentUserId){ 
        errorEl.textContent = 'Please log in to create an order.';
        console.error('Error: User not logged in.'); 
        return; 
    }

    const taskName = document.getElementById('m_taskName').value.trim();
    const selectedLinkType = document.querySelector('input[name="inviteLinkType"]:checked');
    const inviteLinkType = selectedLinkType ? selectedLinkType.value : 'TRC20';
    const groupLinksText = document.getElementById('m_groupLinks').value.trim();
    
    if (!taskName || !groupLinksText) {
        errorEl.textContent = 'Task Name and Group links are required.';
        return;
    }

    const groupLinksArray = groupLinksText.split('\n').map(link => link.trim()).filter(link => link !== '');
    const amount = groupLinksArray.length; 
    
    if(amount === 0) {
        errorEl.textContent = 'Please enter at least one group link.';
        return;
    }

    // UPDATED: Using a fixed price per group for demonstration, based on the price list's highest value
    const pricePerGroup = 14.00; 
    const totalPrice = amount * pricePerGroup;
    const timestamp = firebase.database.ServerValue.TIMESTAMP;
    
    db.ref(`users/${currentUserId}/stats`).once('value').then(statsSnapshot => {
        const stats = statsSnapshot.val() || {};
        const telegramUsername = stats.telegram || (auth.currentUser.email ? auth.currentUser.email.split('@')[0] : 'User');
        
        const newOrderRef = db.ref(`users/${currentUserId}/orders`).push();
        const orderId = newOrderRef.key;
        
        // 1. Create initial record and get its key
        const recordRef = db.ref(`users/${currentUserId}/records`).push();
        const recordKey = recordRef.key;

        const userOrderData = {
            title: taskName, 
            amount: amount, 
            price: pricePerGroup, 
            totalPrice: totalPrice, 
            linkType: inviteLinkType, 
            links: groupLinksText, 
            status: 'Pending',
            transferUsername: null, 
            recordKey: recordKey, // <-- NEW: Store record key with order
            timestamp: timestamp
        };
        
        const adminOrderData = {
            orderId: orderId, 
            submittedByUid: currentUserId,
            submittedByUsername: telegramUsername,
            taskName: taskName,
            groupLinks: groupLinksText, 
            status: 'Pending', 
            recordKey: recordKey, // <-- NEW: Store record key for admin use
            timestamp: timestamp,
            totalPrice: totalPrice, 
            amount: amount,
        };

        // 2. Set Order in User's personal orders
        newOrderRef.set(userOrderData).then(() => {
            
            // 3. Set Order in Admin Queue
            db.ref(`admin_sell_orders_queue/${orderId}`).set(adminOrderData);

            // 4. Update Pending count in stats (Atomic Update for safety)
            const statsRef = db.ref(`users/${currentUserId}/stats`);
            statsRef.child('pending').transaction((currentPending) => {
                return (currentPending || 0) + 1;
            });
            
            // 5. Set the initial record (NO MONETARY AMOUNT)
            recordRef.set({
                type: 'Sell Order Submitted', 
                amount: 0, // Set amount to 0
                status: 'Pending',
                timestamp: timestamp
            });

            document.getElementById('sellForm').reset();
            closeModal('sellModal');
        }).catch(error => {
            errorEl.textContent = 'Failed to create order: ' + error.message;
            console.error('Failed to create order:', error.message);
        });
    }).catch(error => {
        errorEl.textContent = 'Failed to fetch user data: ' + error.message;
        console.error('Failed to fetch user data:', error.message);
    });
}

// MODIFIED: Submit Withdraw Request - Amount stored as negative to signify deduction
function submitWithdraw(e){
    e.preventDefault();
    const errorEl = document.getElementById('withdrawError');
    errorEl.textContent = ''; 

    if(!currentUserId){ 
        errorEl.textContent = 'Please log in to make a withdrawal.';
        console.error('Error: User not logged in.'); 
        return; 
    }

    const amount = parseFloat(document.getElementById('m_withdrawAmount').value);
    const address = document.getElementById('m_withdrawAddress').value.trim();
    
    // Read Wallet Type
    const selectedWalletType = document.querySelector('input[name="wallet_type"]:checked');
    const walletType = selectedWalletType ? selectedWalletType.value : 'TRC20';
    
    const timestamp = firebase.database.ServerValue.TIMESTAMP;
    
    if (amount <= 0 || isNaN(amount)) {
        errorEl.textContent = 'Please enter a valid amount.';
        return;
    }
    
    if (!address) {
        errorEl.textContent = 'Wallet address is required.';
        return;
    }

    if (amount > currentBalance) {
        // CHANGED: Removed Hindi from Insufficient Balance message
        errorEl.textContent = `Insufficient Balance. Available: ${currentBalance.toFixed(2)} USDT`;
        // CHANGED: Removed Hindi from console log
        console.error('Insufficient Balance. Current:', currentBalance);
        return;
    }

    const statsRef = db.ref(`users/${currentUserId}/stats`);
    // Atomically check balance and subtract amount
    statsRef.transaction((currentStats) => {
        if (currentStats && currentStats.balance >= amount) {
            
            // 1. Create Withdrawal Request
            db.ref(`users/${currentUserId}/withdrawals`).push().set({
                amount,
                address,
                walletType, 
                status: 'Pending', 
                timestamp: timestamp
            });
            
            // 2. Add Record
            db.ref(`users/${currentUserId}/records`).push().set({
                type: `Withdraw Request (${walletType})`, 
                amount: -amount, // Store as negative for display consistency (money out)
                status: 'Pending', 
                timestamp: timestamp
            });

            // 3. Update balance in stats
            currentStats.balance = (currentStats.balance || 0) - amount;
            return currentStats; // Commit transaction with new data
        } else if (currentStats) {
            console.error('Transaction failed: Insufficient funds after server check.');
            errorEl.textContent = 'Transaction failed. Please refresh and try again.';
            return; // Abort transaction
        }
        return currentStats;
    }).then(result => {
        if(result.committed) {
             document.getElementById('withdrawForm').reset();
             closeModal('withdrawModal');
        } else {
             // If transaction aborted, error is already shown in console/errorEl
        }
    }).catch(error => {
        errorEl.textContent = 'Withdrawal failed: ' + error.message;
        console.error('Withdrawal failed:', error.message);
    });
}


// NEW: Contact Support Form Submission Handler
function submitContactForm(e){
    e.preventDefault();
    const errorEl = document.getElementById('contactError');
    errorEl.textContent = '';

    const name = document.getElementById('c_name').value.trim();
    const email = document.getElementById('c_email').value.trim();
    const message = document.getElementById('c_msg').value.trim();

    if (!name || !email || !message) {
        errorEl.textContent = 'Please fill in all fields.';
        return;
    }

    if (!currentUserId) {
        errorEl.textContent = 'Please log in to submit a support request.';
        return;
    }

    const supportData = {
        name: name,
        email: email,
        message: message,
        userId: currentUserId,
        telegram: currentTelegramUsername,
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        status: 'New'
    };

    db.ref('support_messages').push().set(supportData)
        .then(() => {
            errorEl.textContent = 'Message sent successfully! We will contact you soon.'; // Success message
            document.getElementById('contactForm').reset();
            setTimeout(() => closeModal('contactModal'), 2500); 
        })
        .catch(error => {
            errorEl.textContent = 'Failed to send message: ' + error.message;
            console.error('Failed to send support message:', error);
        });
}


// ============================
// üöÄ 5. INITIALIZATION
// ============================

document.addEventListener('DOMContentLoaded', () => {
    // Auth form handlers
    document.getElementById('signupForm').addEventListener('submit', (e) => { e.preventDefault(); signUpUser(); });
    document.getElementById('loginForm').addEventListener('submit', (e) => { e.preventDefault(); signInUser(); });
    
    // Transaction form handlers
    document.getElementById('sellForm').addEventListener('submit', createSell);
    document.getElementById('withdrawForm').addEventListener('submit', submitWithdraw);
    
    // Contact form handler (REAL SUBMISSION)
    document.getElementById('contactForm').addEventListener('submit', submitContactForm);

    // Auth state listener (starts the app logic)
    auth.onAuthStateChanged(handleLoginState);

    // --- NEW: Automatic Banner Carousel Logic ---
    
    function showBanner(index) {
        // Hide all banners and deactivate all indicators
        banners.forEach((b, i) => { 
            if(b) b.style.display = 'none'; 
            const indicator = indicatorContainer.querySelector(`[data-index="${i}"]`);
            if(indicator) indicator.classList.remove('active');
        });

        // Show the target banner and activate the target indicator
        if (banners[index]) banners[index].style.display = 'block';
        const activeIndicator = indicatorContainer.querySelector(`[data-index="${index}"]`);
        if (activeIndicator) activeIndicator.classList.add('active');
        
        currentBannerIndex = index;
    }

    function showNextBanner() {
        // Move to the next index (circular)
        const nextIndex = (currentBannerIndex + 1) % banners.length;
        showBanner(nextIndex);
    }
    
    // Attach click handlers to banners (Manual Switch)
    banners.forEach((b, index) => {
        if(b) {
            b.addEventListener('click', () => {
                // Clear the automatic interval
                clearInterval(bannerInterval);
                // Show the next banner instantly
                const nextIndex = (index + 1) % banners.length;
                showBanner(nextIndex);
                // Restart the automatic interval
                bannerInterval = setInterval(showNextBanner, 5000); // Faster Auto Change: 5 seconds
            });
        }
    });

    // Attach click handlers to indicators (Direct Switch)
    if(indicatorContainer) {
        indicatorContainer.querySelectorAll('.banner-indicator').forEach(indicator => {
            indicator.addEventListener('click', (e) => {
                // Clear the automatic interval, then start it again after a delay
                clearInterval(bannerInterval);
                const index = parseInt(e.target.dataset.index);
                showBanner(index);
                bannerInterval = setInterval(showNextBanner, 5000); // Faster Auto Change: 5 seconds
            });
        });
    }

    // Initialize carousel (show first banner)
    if (banners.length > 0) {
        showBanner(0);
        // Start rotating banners every 5 seconds (5000ms)
        let bannerInterval = setInterval(showNextBanner, 5000); 
    }
    // -------------------------------------------
});


/* Other UI/Accessibility (Unchanged) */
document.addEventListener('keydown', (e) => {
  if(e.key === 'Escape'){ closeModal('sellModal'); closeModal('withdrawModal'); closeModal('recordsModal'); closeModal('contactModal'); closeModal('signupModal'); closeModal('loginModal'); closeModal('howItWorksModal'); closeMobile(); }
});
function onResize(){
  if(window.innerWidth <= 768){ setCollapsed(false); closeMobile(); }
  else if(window.innerWidth > 768 && window.innerWidth <= 1024){ setCollapsed(true); } 
  else { setCollapsed(false); }
}
window.addEventListener('resize', onResize);
onResize();

</script>
</body>
</html>